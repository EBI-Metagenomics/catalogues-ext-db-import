## Genome catalogue post-processing scripts for data submission to RNACentral and Uniprot

This repository contains two sets of scripts that are executed after the [genomes catalogue pipeline](https://github.com/EBI-Metagenomics/genomes-catalogue-pipeline) is completed.
Both sets of scripts can be run by the `run_data_generation.sh` script:

```bash
bash run_data_generation.sh \
-f <catalogue-name> \ # the name of the catalogue on the FTP (e.g. human-gut)
-v "v1.0" \ # catalogue version, modify as needed
-r /full/path/to/catalogue/results/folder \ # nextflow results folder

```
When the script completes, it will have generated the following files:  

    ├── additional_data
    │   ├── rnacentral
    │   │   └── <catalogue-name>-rnacentral.json
    │   │   └── <catalogue-name>-rnacentral.json.report
    │   │   └── validator_output.txt
    │   ├── uniprot
    │   │   ├── <catalogue-name>_<version>_uniprot_metadata.tsv
    │   │   ├── preprocessed_taxonomy.tsv
    │   │   ├── uniprot-files/


### Descriptions of the data generation processes

#### RNACentral
The `generate_rnacentral_json.py` script processes the outputs of cmscan to generate a single JSON file per catalogue. The script uses the per-genome GFF files to pull out RNA sequences as well as the metadata table. Only species representatives are included.

A report is generated to keep track of sequences that have been excluded and the reasons for exclusion.

RNACentral's JSON validator can be used to check the output. The validator is run automatically by `run_data_generation.sh`

#### UniProt
The following steps are needed to produce the data for UniProt:
1. Pre-process taxonomy of species representatives by running `preprocess_taxonomy_for_uniprot.py`. Pre-processing is needed to get to the species level taxon and to get an NCBI TaxID and lineage. The script pulls taxonomy information from the GCA accession whenever possible (unless the taxonomy is invalid, e.g., metagenome or virus, or not specific, e.g., uncultured bacterium). If GCA taxonomy cannot be used or the GCA accession is not known, the script uses  a combination of GTDB to NCBI conversion and ENA API/taxonkit look ups to figure out the best taxon name, TaxID and lineage.
2. `generate_uniprot_metadata.py` produces a table for UniProt, showing the quality of each genome and the TaxID. UniProt will use this table to filter the genomes that are ingested.
3. `convert_gbk.py` generated the GBK files for UniProt to ingest. These are based on the GBK files generated by Prokka, with the addition of taxonomy computed in Step 1 and a citation.